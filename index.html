<script>
let VERBS = [];   // 외부 JSON에서 불러올 것
let setSize=20,setIndex=0,currentSet=[],mode="study";
let iStudy=0, qi=0, ok=0, no=0, wrongList=[], history=[];

/* 기존 함수들 (updateStats, showStudyCard, speakTriple, showQuizCard 등등) 그대로 둡니다 */

/* ---------- Init ---------- */
window.addEventListener("DOMContentLoaded",()=>{
  fetch("verbs.json")
    .then(res => res.json())
    .then(data => {
      VERBS = data;
      buildSets();
      setMode("study");
      bindEvents();   // 버튼/단축키 이벤트 등록
    })
    .catch(err => console.error("verbs.json 불러오기 실패:", err));
});

function bindEvents(){
  $("#btnPlay").onclick=()=>{ if(currentSet.length) speakTriple(currentSet[iStudy],parseFloat($("#rate").value),false); };
  $("#btnRepeat").onclick=()=>{ if(currentSet.length) speakTriple(currentSet[iStudy],parseFloat($("#rate").value),true); };
  $("#btnStop").onclick=()=>speechSynthesis.cancel();
  $("#btnNext").onclick=()=>{ speechSynthesis.cancel(); iStudy++; if(iStudy>=currentSet.length) onStudyComplete(); else showStudyCard(); updateStats(); };
  $("#btnPrev").onclick=()=>{ speechSynthesis.cancel(); iStudy=Math.max(iStudy-1,0); showStudyCard(); updateStats(); };

  $("#btnStartStudy").onclick=()=>{
    setMode("study");
    iStudy=0;
    showStudyCard();
    updateStats();
    if(currentSet.length){
      speakTriple(currentSet[iStudy], parseFloat($("#rate").value), $("#autoNext").checked);
    }
  };
  $("#btnStartQuiz").onclick=()=>startQuizFresh();
  $("#btnNextSet").onclick=()=>{ setIndex++; buildSets(); setMode($("#mode").value); };
  $("#btnReset").onclick=()=>{ setIndex=0; buildSets(); setMode("study"); };
  $("#btnWrongOnly").onclick=()=>{ if(!wrongList.length){ alert("오답 없음"); return; }
    currentSet=shuffle(wrongList.slice()); wrongList=[]; ok=0; no=0; qi=0; setMode("quiz"); showQuizCard(); renderWrongs(); updateStats(); };

  $("#mode").addEventListener("change", e=>{
    setMode(e.target.value);
    if(e.target.value==="study" && currentSet.length){
      speakTriple(currentSet[iStudy], parseFloat($("#rate").value), $("#autoNext").checked);
    }
  });
  $("#setSize").addEventListener("change",()=>{
    buildSets();
    setMode($("#mode").value);
  });

  // 단축키
  window.addEventListener("keydown",(e)=>{
    if(e.target.tagName==="INPUT" || e.target.tagName==="SELECT") return;
    if(e.code==="Space"){ e.preventDefault(); if(speechSynthesis.speaking) speechSynthesis.cancel(); else if(mode==="study") $("#btnPlay").click(); }
    if(e.key==="ArrowRight"){ $("#btnNext").click(); }
    if(e.key==="ArrowLeft"){ $("#btnPrev").click(); }
    if(e.key.toLowerCase()==="q"){ $("#btnStartQuiz").click(); }
    if(e.key.toLowerCase()==="s"){ $("#btnStartStudy").click(); }
  });
}
</script>
