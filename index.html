<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë™ì‚¬ ë³€í˜• í•™ìŠµ & 4ì§€ì„ ë‹¤ í€´ì¦ˆ (PWA, TTS ì§„ë‹¨)</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#0f172a; --card:#111827; --panel:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
    --blue:#3b82f6; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Malgun Gothic",Arial,sans-serif; background:var(--bg); color:var(--text); min-height:100svh; display:flex; align-items:center; justify-content:center; }
  .app{ width:min(1000px,94vw); height:min(760px,94svh); display:grid; gap:12px; grid-template-rows:auto auto 1fr auto; }
  .topbar{ display:flex; align-items:center; justify-content:space-between; }
  .brand{ font-weight:800; font-size:20px; letter-spacing:.2px }
  .stats{ font-size:14px; color:var(--muted) }
  .panel{ background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; }
  .controls{ display:grid; gap:8px; grid-template-columns:repeat(6,1fr); }
  .controls label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px }
  .controls select, .controls input[type="checkbox"], .controls input[type="range"]{ width:100%; background:#0b1220; color:var(--text); border:1px solid #263247; border-radius:10px; padding:9px 10px; outline:none; }
  .controls .row{display:flex; align-items:center; gap:8px}
  .progress{ display:flex; align-items:center; gap:10px; margin-top:10px }
  .bar{ position:relative; flex:1; height:12px; background:#0b1220; border:1px solid #263247; border-radius:999px; overflow:hidden }
  .bar>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#2563eb,#22c55e); }
  ./* ê¸°ì¡´: grid-template-columns:1.2fr 1fr; */
.screens {
  display: flex;
  flex-direction: column;   /* ì¢Œìš° â†’ ìœ„ì•„ë˜ */
  gap: 12px;
}
.screens .card {
  width: 100%;
}
.screens .right {
  width: 100%;
  margin-top: 16px;         /* ì¹´ë“œì™€ ê°„ê²© */
}

  .card{ background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
  .prompt-tag{ font-size:12px; color:var(--muted); border:1px dashed #334155; padding:2px 8px; border-radius:999px; margin-bottom:8px }
  .word-big{ font-size:42px; font-weight:800; letter-spacing:.3px; margin:8px 0 10px }
  .triple{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin:4px 0 6px}
  .pill{ padding:8px 12px; border-radius:999px; background:#0b1220; border:1px solid #2a3650; font-weight:700; font-size:18px }
  .pill.hl{ outline:2px solid var(--blue) }
  .mean{ margin-top:8px; font-size:14px; color:#d1d5db }
  .btn{ border:0; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; background:var(--blue); color:white; box-shadow:0 6px 14px rgba(59,130,246,.25) }
  .btn.secondary{ background:#0b1220; color:var(--text); border:1px solid #2a3650; box-shadow:none }
  .btn.warn{ background:var(--amber); box-shadow:0 6px 14px rgba(245,158,11,.25) }
  .btn.ghost{ background:transparent; color:var(--muted); border:1px dashed #334155 }
  .right{ background:var(--card); border-radius:var(--radius); padding:14px; display:flex; flex-direction:column; gap:12px }
  .right .row{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ font-size:12px; color:#d1d5db; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #2a3650 }
  .small{ font-size:12px; color:var(--muted) }
  .qopts{ display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; }
  .opt{ background:#0b1220; border:1px solid #2a3650; border-radius:14px; padding:14px; text-align:center; cursor:pointer; transition:transform .06s ease }
  .opt:active{ transform:scale(.98) }
  .opt .t{ font-size:18px; font-weight:800 }
  .footer{ display:flex; gap:8px; justify-content:space-between; align-items:center }
  .footer .left,.footer .right{ display:flex; gap:8px; flex-wrap:wrap }
  .hidden{ display:none !important }
  /* ëª¨ë‹¬ */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50; }
  .modal.show{ display:flex; }
  .modal .box{ background:var(--panel); border-radius:20px; padding:20px; width:min(560px,92vw); box-shadow:var(--shadow); }
  .modal h3{ margin:0 0 8px 0; font-size:20px }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }

  /* === ì§„ë‹¨ íŒ¨ë„ === */
  .diag-toggle{ display:inline-flex; align-items:center; gap:6px; }
  .diag{ position:fixed; right:12px; bottom:12px; width:min(560px,95vw); background:var(--panel); border:1px solid #334155; border-radius:16px; box-shadow:var(--shadow); display:none; z-index:60; }
  .diag.show{ display:block; }
  .diag .hd{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #2a3650; }
  .diag .ct{ padding:12px; }
  .diag .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .diag .kv{ font-size:12px; color:#cbd5e1; }
  .diag select, .diag input[type="checkbox"]{ background:#0b1220; color:var(--text); border:1px solid #2a3650; border-radius:8px; padding:8px; }
  .diag .btn{ padding:8px 10px; border-radius:8px; font-size:12px; }
  .diag pre{ max-height:180px; overflow:auto; background:#0b1220; border:1px solid #2a3650; padding:8px; border-radius:10px; font-size:12px; color:#e5e7eb; }
</style>
</head>
<body>
<div class="app">
  <!-- ìƒë‹¨ -->
  <div class="topbar">
    <div class="brand">ë™ì‚¬ ë³€í˜• í•™ìŠµ Â· 4ì§€ì„ ë‹¤ í€´ì¦ˆ</div>
    <div class="stats">
      ğŸ”Š <label style="cursor:pointer"><input type="checkbox" id="mute" /> ìŒì†Œê±°</label> Â·
      ì •ë‹µ <span id="ok">0</span> Â· ì˜¤ë‹µ <span id="no">0</span> Â· ë‚¨ì€ <span id="left">0</span> Â· ì„¸íŠ¸ <span id="setIdx">1</span>/<span id="setTotal">1</span>
    </div>
  </div>

  <!-- ì˜µì…˜/ì§„í–‰ë°” -->
  <div class="panel">
    <div class="controls">
      <div>
        <label>ëª¨ë“œ</label>
        <select id="mode">
          <option value="study">í•™ìŠµ(ì½ì–´ì£¼ê¸°)</option>
          <option value="quiz">í€´ì¦ˆ(4ì§€ì„ ë‹¤)</option>
        </select>
      </div>
      <div>
        <label>ì„¸íŠ¸ í¬ê¸°</label>
        <select id="setSize">
          <option value="20" selected>20</option>
          <option value="10">10</option>
          <option value="30">30</option>
        </select>
      </div>
      <div>
        <label>íŒ¨í„´ í•„í„°</label>
        <select id="patternFilter">
          <option value="all">ì „ì²´</option>
          <option value="AAA">AAA</option>
          <option value="ABB">ABB</option>
          <option value="ABA">ABA</option>
          <option value="ABC">ABC</option>
          <option value="REG">REG</option>
        </select>
      </div>
      <div class="row">
        <label style="width:100%">í•™ìŠµ ì†ë„ <span id="spdTxt">1.0</span>x</label>
        <input type="range" id="rate" min="0.8" max="1.2" step="0.05" value="1.0" />
      </div>
      <div class="row">
        <label><input type="checkbox" id="autoNext" /> ìë™ ë‹¤ìŒ(í•™ìŠµ)</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="onlyWrong" /> ì˜¤ë‹µ ì „ìš©(ì„¸íŠ¸ ëë‚˜ë©´ ì˜¤ë‹µë§Œ ì¬ë„ì „)</label>
      </div>
    </div>
    <div class="progress">
      <div class="bar"><i id="bar"></i></div>
      <div class="small"><span id="progTxt">0 / 0</span></div>
    </div>
  </div>

  <!-- ë³¸ë¬¸: í•™ìŠµ & í€´ì¦ˆ -->
  <div class="screens">
    <!-- ì¢Œì¸¡: ë©”ì¸ ì¹´ë“œ -->
    <div class="card">
      <div class="prompt-tag" id="promptTag">í•™ìŠµ ì¹´ë“œ</div>

      <!-- í•™ìŠµ í™”ë©´ -->
      <div id="screenStudy">
        <div class="word-big" id="bWord">ready?</div>
        <div class="triple">
          <span class="pill" id="pBase">base</span>
          <span class="pill" id="pPast">past</span>
          <span class="pill" id="pPP">pp</span>
        </div>
        <div class="mean" id="krMeaning">ëœ»: -</div>
        <div class="row" style="gap:8px; margin-top:8px">
          <button class="btn" id="btnPlay">â–¶ ì½ê¸°</button>
          <button class="btn secondary" id="btnRepeat">âŸ³ ë°˜ë³µ</button>
          <button class="btn secondary" id="btnStop">â—¼ ì •ì§€</button>
          <button class="btn warn" id="btnNext">ë‹¤ìŒ</button>
          <button class="btn ghost" id="btnPrev">ì´ì „</button>
        </div>
      </div>

      <!-- í€´ì¦ˆ í™”ë©´ -->
      <div id="screenQuiz" class="hidden" style="width:100%">
        <div class="word-big" id="qBase">ready?</div>
        <div class="small" style="margin-bottom:8px">
          ì œì‹œëœ <b>í˜„ì¬í˜•</b>ì— ë§ëŠ” <b>í˜„ì¬í˜•â€“ê³¼ê±°í˜•â€“ê³¼ê±°ë¶„ì‚¬í˜•</b> ì„¸íŠ¸ë¥¼ ê³ ë¥´ì„¸ìš”. (ì„ íƒ ì¦‰ì‹œ ë‹¤ìŒ ë¬¸ì œ)
        </div>
        <div class="qopts" id="opts"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ë³´ì¡° íŒ¨ë„ -->
    <div class="right">
      <div class="row">
        <button class="btn ghost" id="btnStartStudy">ì´ ì„¸íŠ¸ í•™ìŠµ ì‹œì‘</button>
        <button class="btn ghost" id="btnStartQuiz">ì„¸íŠ¸ í€´ì¦ˆ ì‹œì‘</button>
        <button class="btn ghost" id="btnNextSet">ë‹¤ìŒ ì„¸íŠ¸ â–¶</button>
      </div>
      <div>
        <div class="small">ìµœê·¼ ì •ë‹µ</div>
        <div id="history" class="row"></div>
      </div>
      <div>
        <div class="small">ì˜¤ë‹µ ëª©ë¡ (<span id="wcount">0</span>) â€” ì˜¤ë‹µ ì „ìš©ìœ¼ë¡œ ì¬ë„ì „ ê°€ëŠ¥</div>
        <div id="wrongs" class="row"></div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ -->
  <div class="footer">
    <div class="left">
      <button class="btn ghost" id="btnReset">ì´ˆê¸°í™”</button>
      <button class="btn ghost" id="btnWrongOnly">ì˜¤ë‹µë§Œ í’€ê¸°</button>
      <button class="btn ghost diag-toggle" id="btnDiag">ğŸ›  ì§„ë‹¨</button>
    </div>
    <div class="right small">íš¨ê³¼ìŒ: <code>audio/correct.mp3</code>, <code>audio/wrong.mp3</code></div>
  </div>
</div>

<!-- íš¨ê³¼ìŒ -->
<audio id="sndCorrect" src="audio/correct.mp3" preload="auto"></audio>
<audio id="sndWrong"   src="audio/wrong.mp3"   preload="auto"></audio>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="modalTitle">ì•Œë¦¼</h3>
    <div id="modalBody" class="small" style="line-height:1.6"></div>
    <div class="row" style="margin-top:12px; gap:8px; justify-content:flex-end">
      <button class="btn secondary" id="btnModalClose">ë‹«ê¸°</button>
      <button class="btn" id="btnModalAction">í€´ì¦ˆ ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- ì§„ë‹¨ íŒ¨ë„ -->
<div class="diag" id="diag">
  <div class="hd">
    <div style="font-weight:800">ğŸ”§ TTS ì§„ë‹¨ íŒ¨ë„</div>
    <div class="row">
      <button class="btn secondary" id="btnDiagClose">ë‹«ê¸°</button>
    </div>
  </div>
  <div class="ct">
    <div class="row">
      <div class="kv">voicesReady: <b id="dReady">false</b></div>
      <div class="kv">ttsWarmed: <b id="dWarmed">false</b></div>
      <div class="kv">voices: <b id="dCount">0</b>ê°œ</div>
      <div class="kv">ì„ íƒ ë³´ì´ìŠ¤: <b id="dChosen">-</b></div>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="kv"><input type="checkbox" id="dOverride" /> ì„ íƒí•œ ë³´ì´ìŠ¤ ê°•ì œ ì‚¬ìš©</label>
      <select id="dVoice" style="min-width:240px"></select>
      <button class="btn" id="dRefresh">Refresh voices</button>
      <button class="btn" id="dWarm">Warmup</button>
      <button class="btn secondary" id="dStop">Stop/Cancel</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="dSayHello">ìƒ˜í”Œ ì½ê¸°("hello")</button>
      <button class="btn" id="dSayTriple">í˜„ì¬ ì¹´ë“œ 3ë‹¨ê³„ ì½ê¸°</button>
      <button class="btn secondary" id="dPlayCorrect">íš¨ê³¼ìŒ(correct)</button>
      <button class="btn secondary" id="dPlayWrong">íš¨ê³¼ìŒ(wrong)</button>
    </div>
    <div style="margin-top:8px">
      <div class="small">ë³´ì´ìŠ¤ ëª©ë¡</div>
      <pre id="dVoices"></pre>
    </div>
    <div style="margin-top:8px">
      <div class="small">ë¡œê·¸</div>
      <pre id="dLog"></pre>
      <div class="row">
        <button class="btn" id="dCopy">ë¡œê·¸ ë³µì‚¬</button>
        <button class="btn secondary" id="dClear">ë¡œê·¸ ì§€ìš°ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   0) ê³µí†µ ë„ìš°ë¯¸
   ========================================================= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
const sleep = (ms)=> new Promise(res=>setTimeout(res, ms));

/* =========================================================
   1) ì˜ë¯¸(êµ­ë¬¸) ì‚¬ì „
   ========================================================= */
const KR = {
  // AAA
  cut:"ìë¥´ë‹¤", hit:"ì¹˜ë‹¤", let:"~í•˜ê²Œ í•˜ë‹¤", put:"ë†“ë‹¤/ë‘ë‹¤", set:"ë†“ë‹¤/ì„¤ì •í•˜ë‹¤", shut:"ë‹«ë‹¤",
  cost:"ë¹„ìš©ì´ ë“¤ë‹¤", hurt:"ë‹¤ì¹˜ê²Œ í•˜ë‹¤/ì•„í”„ë‹¤", burst:"í„°ì§€ë‹¤", spread:"í¼ì§€ë‹¤/í´ë‹¤", split:"ìª¼ê°œë‹¤",
  read:"ì½ë‹¤", quit:"ê·¸ë§Œë‘ë‹¤", bet:"ë‚´ê¸°í•˜ë‹¤", cast:"ë˜ì§€ë‹¤/ë°°ì—­ ì •í•˜ë‹¤",
  // ABB
  keep:"ìœ ì§€í•˜ë‹¤", sleep:"ìë‹¤", feel:"ëŠë¼ë‹¤", leave:"ë– ë‚˜ë‹¤/ë‚¨ê¸°ë‹¤", meet:"ë§Œë‚˜ë‹¤", send:"ë³´ë‚´ë‹¤",
  lend:"ë¹Œë ¤ì£¼ë‹¤", spend:"ì“°ë‹¤/ë³´ë‚´ë‹¤", build:"ì§“ë‹¤", bring:"ê°€ì ¸ì˜¤ë‹¤", buy:"ì‚¬ë‹¤",
  catch:"ì¡ë‹¤", teach:"ê°€ë¥´ì¹˜ë‹¤", think:"ìƒê°í•˜ë‹¤", sell:"íŒ”ë‹¤", tell:"ë§í•˜ë‹¤", say:"ë§í•˜ë‹¤",
  make:"ë§Œë“¤ë‹¤", have:"ê°€ì§€ë‹¤", hear:"ë“£ë‹¤", hold:"ì¡ë‹¤/ê°œìµœí•˜ë‹¤", sit:"ì•‰ë‹¤", stand:"ì„œë‹¤",
  win:"ì´ê¸°ë‹¤", lose:"ì§€ë‹¤/ìƒë‹¤", lead:"ì´ëŒë‹¤", find:"ì°¾ë‹¤", feed:"ë¨¹ì´ë¥¼ ì£¼ë‹¤", fight:"ì‹¸ìš°ë‹¤",
  hang:"ê±¸ë‹¤/ë§¤ë‹¬ë‹¤", seek:"ì°¾ë‹¤/ì¶”êµ¬í•˜ë‹¤", shoot:"ì˜ë‹¤",
  // ABA
  become:"~ì´ ë˜ë‹¤", come:"ì˜¤ë‹¤", run:"ë‹¬ë¦¬ë‹¤", overcome:"ê·¹ë³µí•˜ë‹¤",
  // ABC
  go:"ê°€ë‹¤", begin:"ì‹œì‘í•˜ë‹¤", drink:"ë§ˆì‹œë‹¤", ring:"ìš¸ë¦¬ë‹¤", sing:"ë…¸ë˜í•˜ë‹¤", swim:"ìˆ˜ì˜í•˜ë‹¤",
  shrink:"ì¤„ì–´ë“¤ë‹¤", speak:"ë§í•˜ë‹¤", steal:"í›”ì¹˜ë‹¤", break:"ë¶€ìˆ˜ë‹¤/ê¹¨ì§€ë‹¤", choose:"ì„ íƒí•˜ë‹¤",
  write:"ì“°ë‹¤", drive:"ìš´ì „í•˜ë‹¤", ride:"íƒ€ë‹¤", rise:"ì˜¤ë¥´ë‹¤/ì¼ì–´ë‚˜ë‹¤", fall:"ë–¨ì–´ì§€ë‹¤/ë„˜ì–´ì§€ë‹¤",
  fly:"ë‚ ë‹¤", draw:"ê·¸ë¦¬ë‹¤/ëŒì–´ë‹¹ê¸°ë‹¤", see:"ë³´ë‹¤", take:"ê°€ì ¸ê°€ë‹¤/ë°ë ¤ê°€ë‹¤", give:"ì£¼ë‹¤",
  eat:"ë¨¹ë‹¤", hide:"ìˆ¨ë‹¤/ìˆ¨ê¸°ë‹¤", forget:"ìŠë‹¤", forgive:"ìš©ì„œí•˜ë‹¤", forbid:"ê¸ˆì§€í•˜ë‹¤",
  wake:"ê¹¨ë‹¤/ê¹¨ìš°ë‹¤", wear:"ì…ë‹¤/ì°©ìš©í•˜ë‹¤", tear:"ì°¢ë‹¤", shake:"í”ë“¤ë‹¤", freeze:"ì–¼ë‹¤/ì–¼ë¦¬ë‹¤",
  bite:"ë¬¼ë‹¤", blow:"ë¶ˆë‹¤", grow:"ìë¼ë‹¤/ê¸°ë¥´ë‹¤", know:"ì•Œë‹¤", throw:"ë˜ì§€ë‹¤",
  show:"ë³´ì—¬ì£¼ë‹¤", prove:"ì¦ëª…í•˜ë‹¤", sew:"ë°”ëŠì§ˆí•˜ë‹¤", be:"~ì´ë‹¤/ìˆë‹¤", do:"í•˜ë‹¤",
  // REG (ëŒ€í‘œ)
  walk:"ê±·ë‹¤", work:"ì¼í•˜ë‹¤", play:"ë†€ë‹¤/ì—°ì£¼í•˜ë‹¤", use:"ì‚¬ìš©í•˜ë‹¤", call:"ì „í™”í•˜ë‹¤/ë¶€ë¥´ë‹¤", look:"ë³´ë‹¤",
  ask:"ë¬»ë‹¤/ìš”ì²­í•˜ë‹¤", need:"í•„ìš”í•˜ë‹¤", move:"ì›€ì§ì´ë‹¤/ì´ì‚¬í•˜ë‹¤", live:"ì‚´ë‹¤", help:"ë•ë‹¤", talk:"ë§í•˜ë‹¤",
  turn:"ëŒë‹¤/ëŒë¦¬ë‹¤", start:"ì‹œì‘í•˜ë‹¤", stop:"ë©ˆì¶”ë‹¤", plan:"ê³„íší•˜ë‹¤", open:"ì—´ë‹¤", close:"ë‹«ë‹¤",
  change:"ë°”ê¾¸ë‹¤", follow:"ë”°ë¥´ë‹¤", allow:"í—ˆë½í•˜ë‹¤", add:"ë”í•˜ë‹¤", stay:"ë¨¸ë¬´ë¥´ë‹¤", reach:"ë„ë‹¬í•˜ë‹¤",
  include:"í¬í•¨í•˜ë‹¤", continue:"ê³„ì†í•˜ë‹¤", learn:"ë°°ìš°ë‹¤", watch:"ë³´ë‹¤/ì§€ì¼œë³´ë‹¤", carry:"ë‚˜ë¥´ë‹¤/ê°€ì§€ê³  ë‹¤ë‹ˆë‹¤",
  study:"ê³µë¶€í•˜ë‹¤", finish:"ëë‚´ë‹¤", wash:"ì”»ë‹¤/ì„¸íƒí•˜ë‹¤", paint:"ê·¸ë¦¬ë‹¤/í˜ì¸íŠ¸ì¹ í•˜ë‹¤", cook:"ìš”ë¦¬í•˜ë‹¤",
  clean:"ì²­ì†Œí•˜ë‹¤", rain:"ë¹„ê°€ ì˜¤ë‹¤", snow:"ëˆˆì´ ì˜¤ë‹¤", travel:"ì—¬í–‰í•˜ë‹¤", visit:"ë°©ë¬¸í•˜ë‹¤", enjoy:"ì¦ê¸°ë‹¤",
  hope:"í¬ë§í•˜ë‹¤", love:"ì‚¬ë‘í•˜ë‹¤", like:"ì¢‹ì•„í•˜ë‹¤", hate:"ë¯¸ì›Œí•˜ë‹¤/ì‹«ì–´í•˜ë‹¤", miss:"ê·¸ë¦¬ì›Œí•˜ë‹¤/ë†“ì¹˜ë‹¤",
  smile:"ë¯¸ì†Œì§“ë‹¤", laugh:"ì›ƒë‹¤", cry:"ìš¸ë‹¤", agree:"ë™ì˜í•˜ë‹¤", decide:"ê²°ì •í•˜ë‹¤", invite:"ì´ˆëŒ€í•˜ë‹¤",
  answer:"ëŒ€ë‹µí•˜ë‹¤", order:"ì£¼ë¬¸í•˜ë‹¤/ëª…ë ¹í•˜ë‹¤", save:"ì €ì¶•/êµ¬í•˜ë‹¤", cover:"ë®ë‹¤/ì·¨ì¬í•˜ë‹¤",
  plant:"ì‹¬ë‹¤", climb:"ì˜¤ë¥´ë‹¤", jump:"ë›°ë‹¤", kick:"ì°¨ë‹¤", guess:"ì¶”ì¸¡í•˜ë‹¤", fix:"ê³ ì¹˜ë‹¤/ìˆ˜ë¦¬í•˜ë‹¤",
  point:"ê°€ë¦¬í‚¤ë‹¤", push:"ë°€ë‹¤", pull:"ë‹¹ê¸°ë‹¤", pack:"ì§ì„ ì‹¸ë‹¤", pick:"ê³ ë¥´ë‹¤/ë”°ë‹¤",
  print:"ì¸ì‡„í•˜ë‹¤", promise:"ì•½ì†í•˜ë‹¤", return:"ëŒì•„ì˜¤ë‹¤/ë°˜í™˜í•˜ë‹¤", share:"ê³µìœ í•˜ë‹¤", shout:"ì†Œë¦¬ì¹˜ë‹¤",
  smell:"ëƒ„ìƒˆ ë§¡ë‹¤/ëƒ„ìƒˆê°€ ë‚˜ë‹¤", touch:"ë§Œì§€ë‹¤", wait:"ê¸°ë‹¤ë¦¬ë‹¤", warn:"ê²½ê³ í•˜ë‹¤", wave:"ì†ì„ í”ë“¤ë‹¤",
  yell:"ê³ í•¨ì¹˜ë‹¤", check:"í™•ì¸í•˜ë‹¤", chase:"ì«“ë‹¤", count:"ì„¸ë‹¤", cross:"ê±´ë„ˆë‹¤/ì‹­ìí‘œí•˜ë‹¤",
  cycle:"ìì „ê±° íƒ€ë‹¤", deliver:"ë°°ë‹¬í•˜ë‹¤", design:"ë””ìì¸í•˜ë‹¤/ì„¤ê³„í•˜ë‹¤", dress:"ì˜·ì„ ì…ë‹¤/ì…íˆë‹¤",
  drop:"ë–¨ì–´ëœ¨ë¦¬ë‹¤/ë–¨ì–´ì§€ë‹¤", earn:"ë²Œë‹¤", end:"ëë‚˜ë‹¤/ëë‚´ë‹¤", enter:"ì…ì¥í•˜ë‹¤/ì…ë ¥í•˜ë‹¤",
  exercise:"ìš´ë™í•˜ë‹¤", fill:"ì±„ìš°ë‹¤", film:"ì´¬ì˜í•˜ë‹¤", fish:"ë‚šì‹œí•˜ë‹¤", greet:"ì¸ì‚¬í•˜ë‹¤", guide:"ì•ˆë‚´í•˜ë‹¤",
  handle:"ë‹¤ë£¨ë‹¤", hurry:"ì„œë‘ë¥´ë‹¤", improve:"ê°œì„ í•˜ë‹¤", join:"ê°€ì…í•˜ë‹¤/ì°¸ê°€í•˜ë‹¤", knock:"ë…¸í¬í•˜ë‹¤",
  land:"ì°©ë¥™í•˜ë‹¤/ë‚´ë¦¬ë‹¤", mail:"ìš°í¸ìœ¼ë¡œ ë³´ë‚´ë‹¤", mark:"í‘œì‹œí•˜ë‹¤", match:"ì–´ìš¸ë¦¬ë‹¤/ê²½ê¸°í•˜ë‹¤",
  measure:"ì¸¡ì •í•˜ë‹¤", notice:"ì•Œì•„ì°¨ë¦¬ë‹¤", phone:"ì „í™”í•˜ë‹¤", post:"ìš°í¸/ê²Œì‹œí•˜ë‹¤", prefer:"ë” ì¢‹ì•„í•˜ë‹¤",
  prepare:"ì¤€ë¹„í•˜ë‹¤", press:"ëˆ„ë¥´ë‹¤/ì–¸ë¡ ", repair:"ìˆ˜ë¦¬í•˜ë‹¤", report:"ë³´ê³ í•˜ë‹¤", sail:"í•­í•´í•˜ë‹¤",
  scare:"ê²ì£¼ë‹¤", score:"ë“ì í•˜ë‹¤", search:"ì°¾ë‹¤/ê²€ìƒ‰í•˜ë‹¤", skip:"ê±´ë„ˆë›°ë‹¤", solve:"í•´ê²°í•˜ë‹¤",
  sound:"~ì²˜ëŸ¼ ë“¤ë¦¬ë‹¤", thank:"ê°ì‚¬í•˜ë‹¤", type:"íƒ€ì´í•‘í•˜ë‹¤/ìœ í˜•", whisper:"ì†ì‚­ì´ë‹¤", worry:"ê±±ì •í•˜ë‹¤",
  arrive:"ë„ì°©í•˜ë‹¤", attack:"ê³µê²©í•˜ë‹¤", bake:"êµ½ë‹¤", believe:"ë¯¿ë‹¤", brush:"ì†”ì§ˆ/ì–‘ì¹˜í•˜ë‹¤", camp:"ì•¼ì˜í•˜ë‹¤",
  cancel:"ì·¨ì†Œí•˜ë‹¤", cheer:"ì‘ì›í•˜ë‹¤", collect:"ìˆ˜ì§‘í•˜ë‹¤", compare:"ë¹„êµí•˜ë‹¤", complete:"ì™„ì„±í•˜ë‹¤",
  control:"í†µì œí•˜ë‹¤", copy:"ë³µì‚¬í•˜ë‹¤", correct:"ìˆ˜ì •í•˜ë‹¤/ì˜³ê²Œ í•˜ë‹¤", dance:"ì¶¤ì¶”ë‹¤", date:"ë°ì´íŠ¸/ë‚ ì§œ í‘œê¸°",
  decorate:"ì¥ì‹í•˜ë‹¤", describe:"ë¬˜ì‚¬í•˜ë‹¤", discover:"ë°œê²¬í•˜ë‹¤", explain:"ì„¤ëª…í•˜ë‹¤", fail:"ì‹¤íŒ¨í•˜ë‹¤",
  fold:"ì ‘ë‹¤", gather:"ëª¨ìœ¼ë‹¤/ëª¨ì´ë‹¤", grade:"ì„±ì  ë§¤ê¸°ë‹¤", hand:"ê±´ë„¤ì£¼ë‹¤", identify:"ì‹ë³„í•˜ë‹¤",
  imagine:"ìƒìƒí•˜ë‹¤", introduce:"ì†Œê°œí•˜ë‹¤", jog:"ì¡°ê¹…í•˜ë‹¤", list:"ëª©ë¡ ì‘ì„±í•˜ë‹¤", listen:"ë“£ë‹¤",
  march:"í–‰ì§„í•˜ë‹¤", name:"ì´ë¦„ì§“ë‹¤", note:"ë©”ëª¨í•˜ë‹¤", pass:"í†µê³¼í•˜ë‹¤/ê±´ë„¤ì£¼ë‹¤", practice:"ì—°ìŠµí•˜ë‹¤",
  protect:"ë³´í˜¸í•˜ë‹¤", race:"ê²½ì£¼í•˜ë‹¤", receive:"ë°›ë‹¤", record:"ê¸°ë¡í•˜ë‹¤/ë…¹ìŒí•˜ë‹¤", reduce:"ì¤„ì´ë‹¤",
  remove:"ì œê±°í•˜ë‹¤", repeat:"ë°˜ë³µí•˜ë‹¤", replace:"êµì²´í•˜ë‹¤", rescue:"êµ¬ì¡°í•˜ë‹¤", roll:"êµ¬ë¥´ë‹¤/ë§ë‹¤",
  serve:"ë´‰ì‚¬/ì œê³µí•˜ë‹¤", shop:"ì‡¼í•‘í•˜ë‹¤", ski:"ìŠ¤í‚¤ íƒ€ë‹¤", smoke:"ì—°ê¸° ë‚˜ë‹¤/ë‹´ë°° í”¼ìš°ë‹¤",
  start:"ì‹œì‘í•˜ë‹¤", test:"ì‹œí—˜í•˜ë‹¤", tidy:"ì •ëˆí•˜ë‹¤", train:"í›ˆë ¨í•˜ë‹¤/ê¸°ì°¨ë¡œ ê°€ë‹¤",
  visit:"ë°©ë¬¸í•˜ë‹¤", wait:"ê¸°ë‹¤ë¦¬ë‹¤", watch:"ë³´ë‹¤", work:"ì¼í•˜ë‹¤", walk:"ê±·ë‹¤", wash:"ì”»ë‹¤", study:"ê³µë¶€í•˜ë‹¤",
  travel:"ì—¬í–‰í•˜ë‹¤", organize:"ì¡°ì§í•˜ë‹¤", park:"ì£¼ì°¨í•˜ë‹¤", pour:"ë¶“ë‹¤"
};

/* =========================================================
   2) ë™ì‚¬ ë°ì´í„°(ë¶ˆê·œì¹™ + ê·œì¹™ìƒì„±)
   ========================================================= */
const IRREG = [
  // AAA
  ["cut","cut","cut","AAA"],["hit","hit","hit","AAA"],["let","let","let","AAA"],["put","put","put","AAA"],
  ["set","set","set","AAA"],["shut","shut","shut","AAA"],["cost","cost","cost","AAA"],["hurt","hurt","hurt","AAA"],
  ["burst","burst","burst","AAA"],["spread","spread","spread","AAA"],["split","split","split","AAA"],
  ["read","read","read","AAA"],["quit","quit","quit","AAA"],["bet","bet","bet","AAA"],["cast","cast","cast","AAA"],
  // ABB
  ["keep","kept","kept","ABB"],["sleep","slept","slept","ABB"],["feel","felt","felt","ABB"],["leave","left","left","ABB"],
  ["meet","met","met","ABB"],["send","sent","sent","ABB"],["lend","lent","lent","ABB"],["spend","spent","spent","ABB"],
  ["build","built","built","ABB"],["bring","brought","brought","ABB"],["buy","bought","bought","ABB"],
  ["catch","caught","caught","ABB"],["teach","taught","taught","ABB"],["think","thought","thought","ABB"],
  ["sell","sold","sold","ABB"],["tell","told","told","ABB"],["say","said","said","ABB"],["make","made","made","ABB"],
  ["have","had","had","ABB"],["hear","heard","heard","ABB"],["hold","held","held","ABB"],["sit","sat","sat","ABB"],
  ["stand","stood","stood","ABB"],["win","won","won","ABB"],["lose","lost","lost","ABB"],["lead","led","led","ABB"],
  ["find","found","found","ABB"],["feed","fed","fed","ABB"],["fight","fought","fought","ABB"],
  ["hang","hung","hung","ABB"],["seek","sought","sought","ABB"],["shoot","shot","shot","ABB"],
  // ABA
  ["become","became","become","ABA"],["come","came","come","ABA"],["run","ran","run","ABA"],["overcome","overcame","overcome","ABA"],
  // ABC
  ["go","went","gone","ABC"],["begin","began","begun","ABC"],["drink","drank","drunk","ABC"],["ring","rang","rung","ABC"],
  ["sing","sang","sung","ABC"],["swim","swam","swum","ABC"],["shrink","shrank","shrunk","ABC"],["speak","spoke","spoken","ABC"],
  ["steal","stole","stolen","ABC"],["break","broke","broken","ABC"],["choose","chose","chosen","ABC"],
  ["write","wrote","written","ABC"],["drive","drove","driven","ABC"],["ride","rode","ridden","ABC"],["rise","rose","risen","ABC"],
  ["fall","fell","fallen","ABC"],["fly","flew","flown","ABC"],["draw","drew","drawn","ABC"],["see","saw","seen","ABC"],
  ["take","took","taken","ABC"],["give","gave","given","ABC"],["eat","ate","eaten","ABC"],["hide","hid","hidden","ABC"],
  ["forget","forgot","forgotten","ABC"],["forgive","forgave","forgiven","ABC"],["forbid","forbade","forbidden","ABC"],
  ["wake","woke","woken","ABC"],["wear","wore","worn","ABC"],["tear","tore","torn","ABC"],["shake","shook","shaken","ABC"],
  ["freeze","froze","frozen","ABC"],["bite","bit","bitten","ABC"],["blow","blew","blown","ABC"],["grow","grew","grown","ABC"],
  ["know","knew","known","ABC"],["throw","threw","thrown","ABC"],["show","showed","shown","ABC"],["prove","proved","proven","ABC"],
  ["sew","sewed","sewn","ABC"],["be","was/were","been","ABC"],["do","did","done","ABC"]
];

const REG_BASES = [
  "walk","work","play","use","call","look","ask","need","move","live","help","talk","turn","start","stop","plan","open","close",
  "change","follow","allow","add","stay","reach","include","continue","learn","watch","carry","study","finish","wash","paint",
  "cook","clean","rain","snow","travel","visit","enjoy","hope","love","like","hate","miss","smile","laugh","cry","agree",
  "decide","invite","answer","order","save","cover","plant","climb","jump","kick","guess","fix","point","push","pull","pack",
  "pick","print","promise","return","share","shout","smell","touch","wait","warn","wave","yell","check","chase","count","cross",
  "cycle","deliver","design","dress","drop","earn","end","enter","exercise","fill","film","fish","greet","guide","handle",
  "hurry","improve","join","knock","land","mail","mark","match","measure","notice","phone","post","prefer","prepare","press",
  "repair","report","sail","scare","score","search","skip","solve","sound","thank","type","whisper","worry","arrive","attack",
  "bake","believe","brush","camp","cancel","cheer","collect","compare","complete","control","copy","correct","dance","date",
  "decorate","describe","discover","explain","fail","fold","gather","grade","hand","identify","imagine","introduce","jog",
  "list","listen","march","name","note","pass","practice","protect","race","receive","record","reduce","remove","repeat",
  "replace","rescue","roll","serve","shop","ski","smoke","start","test","tidy","train","visit","wait","watch","work","walk",
  "wash","study","travel","organize","park","pour"
];

// ê·œì¹™ ë³€í™˜(ë¯¸êµ­ì‹)
function makeRegular(base){
  const vowels="aeiou";
  const last = base.slice(-1);
  if(last==="e") return {base, past: base+"d", pp: base+"d", pattern:"REG"};
  if(last==="y" && !vowels.includes(base.slice(-2,-1))) return {base, past: base.slice(0,-1)+"ied", pp: base.slice(0,-1)+"ied", pattern:"REG"};
  const cvc = (w)=>{
    if(w.length<3 || w.length>5) return false;
    const c = x => !"aeiou".includes(x);
    const v = x => "aeiou".includes(x);
    const a=w[w.length-3], b=w[w.length-2], c3=w[w.length-1];
    const doubleable = "bdgklmnprt".includes(c3);
    return c(a)&&v(b)&&c(c3)&&doubleable;
  };
  if(cvc(base)) return {base, past: base+base.slice(-1)+"ed", pp: base+base.slice(-1)+"ed", pattern:"REG"};
  return {base, past: base+"ed", pp: base+"ed", pattern:"REG"};
}

// í•©ì¹˜ê³  ì˜ë¯¸(kr) ë¶€ì—¬ + ì¤‘ë³µ ì œê±°
const RAW=[]; const seenKey=new Set();
for(const [b,p,pp,pat] of IRREG){
  const key=`${b}|${p}|${pp}`; if(!seenKey.has(key)){ seenKey.add(key); RAW.push({base:b,past:p,pp:pp,pattern:pat,kr:KR[b]||"-"}); }
}
for(const b of REG_BASES){
  const r = makeRegular(b); const key=`${r.base}|${r.past}|${r.pp}`;
  if(!seenKey.has(key)){ seenKey.add(key); RAW.push({...r, kr:KR[r.base]||"-"}); }
}
const VERBS = RAW.slice(0, 210);

/* =========================================================
   3) ìƒíƒœ & ì˜¤ë””ì˜¤/TTS ì¤€ë¹„
   ========================================================= */
let setSize = 20;
let setIndex = 0;
let currentSet = [];
let mode = 'study';

let iStudy = 0;
let lastUtters = [];

let qOrder = [];
let qi = 0;
let ok=0, no=0;
let wrongList = [];
let history = [];
let qLocked = false;

let patternTotals = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
let patternCorrect = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};

// íš¨ê³¼ìŒ: ì²« í„°ì¹˜ ì–¸ë½
function unlockAudioOnce() {
  ["sndCorrect","sndWrong"].forEach(id => {
    const a = document.getElementById(id); if(!a) return;
    a.muted = true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; }).catch(()=>{});
  });
  // TTS ì›œì—…ë„ í•¨ê»˜
  warmupTTS().catch(()=>{});
  window.removeEventListener("pointerdown", unlockAudioOnce);
}
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });

function playSnd(isCorrect){
  const muted = $("#mute")?.checked; if(muted) return;
  const el = $(isCorrect ? "#sndCorrect" : "#sndWrong");
  if(!el) return; try{ el.currentTime = 0; el.play(); }catch(e){}
}

/* =========================================================
   3-1) TTS ëª¨ë°”ì¼ ì•ˆì •í™”: ë³´ì´ìŠ¤ ì¤€ë¹„ & ì›œì—… (+ì§„ë‹¨ í›…)
   ========================================================= */
const speakApi = window.speechSynthesis;
let voicesReady = false;
let ttsWarmed = false;
let voicesChangedCount = 0;

function logDiag(msg){ 
  const el = $('#dLog'); if(!el) return;
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  el.textContent += (el.textContent ? '\n' : '') + line;
  el.scrollTop = el.scrollHeight;
}

function waitVoices(timeoutMs=1500){
  return new Promise(resolve=>{
    const have = speakApi && speakApi.getVoices && speakApi.getVoices().length>0;
    if(have){ voicesReady = true; updateDiag(); resolve(true); return; }
    let done = false;
    const onChange = ()=>{
      if(done) return;
      if(speakApi.getVoices().length>0){ 
        done=true; voicesReady=true; voicesChangedCount++; 
        speakApi.removeEventListener('voiceschanged', onChange); 
        logDiag('voiceschanged fired; voices=' + speakApi.getVoices().length);
        updateDiag(); 
        resolve(true); 
      }
    };
    speakApi.addEventListener('voiceschanged', onChange, { once:true });
    setTimeout(()=>{ 
      if(!done){ 
        done=true; voicesReady = speakApi.getVoices().length>0; 
        logDiag('voices load timeout; voices=' + speakApi.getVoices().length); 
        updateDiag(); 
        resolve(voicesReady); 
      } 
    }, timeoutMs);
  });
}
function pickEnglishVoice(){
  const vs = (speakApi && speakApi.getVoices) ? speakApi.getVoices() : [];
  // ì§„ë‹¨ì—ì„œ ë³´ì´ìŠ¤ ê°•ì œ ì§€ì •ì‹œ ê·¸ ë³´ì´ìŠ¤ ìš°ì„ 
  if($('#dOverride')?.checked){
    const sel = $('#dVoice');
    const idx = sel ? Number(sel.value) : -1;
    if(!isNaN(idx) && vs[idx]) return vs[idx];
  }
  let v = vs.find(v=>/en-US/i.test(v.lang) && /female|samantha|zoe|allison|aria|female/i.test(v.name));
  if(!v) v = vs.find(v=>/en-US/i.test(v.lang));
  if(!v) v = vs.find(v=>/en/i.test(v.lang));
  return v || null;
}
async function warmupTTS(){
  if(ttsWarmed) return;
  if(!window.speechSynthesis) return;
  await waitVoices(1500); // ê°€ëŠ¥í•˜ë©´ ë³´ì´ìŠ¤ ë¡œë“œ
  try{
    const u = new SpeechSynthesisUtterance("a"); // ì•„ì£¼ ì§§ì€ ë°œí™”
    u.volume = 0.0; // ë¬´ìŒ ì›œì—…
    u.rate = 1.0; u.pitch = 1.0; u.lang = "en-US";
    const v = pickEnglishVoice(); if(v) u.voice = v;
    return new Promise(res=>{
      u.onend = ()=>{ ttsWarmed = true; updateDiag(); logDiag('warmup onend'); res(); };
      // iOSì—ì„œ onend ì•ˆ ì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„ íƒ€ì„ì•„ì›ƒ
      setTimeout(()=>{ if(!ttsWarmed){ ttsWarmed = true; updateDiag(); logDiag('warmup timeout'); res(); } }, 400);
      speakApi.cancel();
      logDiag('warmup speak()');
      speakApi.speak(u);
    });
  }catch(e){ ttsWarmed = true; updateDiag(); logDiag('warmup error: '+e); }
}

/* =========================================================
   4) ì§„í–‰ë°”/í†µê³„
   ========================================================= */
function updateStats(){
  const total = currentSet.length;
  const done = (mode==='quiz') ? (ok+no) : iStudy;
  $('#ok').textContent = ok;
  $('#no').textContent = no;
  $('#left').textContent = clamp(total - (mode==='quiz' ? (ok+no) : iStudy),0,999);
  $('#progTxt').textContent = `${done} / ${total}`;
  $('#bar').style.width = (total ? (done/total*100) : 0) + '%';
  $('#wcount').textContent = wrongList.length;
  renderHistory(); renderWrongs();
}

/* =========================================================
   5) ì„¸íŠ¸ êµ¬ì„±/í•„í„°
   ========================================================= */
function buildSets(){
  setSize = parseInt($('#setSize').value,10)||20;
  const pf = $('#patternFilter').value;
  let list = VERBS.filter(v => pf==='all' ? true : v.pattern===pf);
  list = shuffle(list.slice());

  const total = Math.max(1, Math.ceil(list.length / setSize));
  if(setIndex >= total) setIndex = 0;
  $('#setIdx').textContent = setIndex+1;
  $('#setTotal').textContent = total;

  currentSet = list.slice(setIndex*setSize, setIndex*setSize + setSize);

  patternTotals = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
  patternCorrect = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
  currentSet.forEach(v => patternTotals[v.pattern]++);

  iStudy = 0; stopSpeak(); showStudyCard();

  ok = 0; no = 0; wrongList=[]; history=[];
  qi = 0; qOrder = shuffle([...currentSet.keys()]);
  showQuizCard(); updateStats();
}

/* =========================================================
   6) í•™ìŠµ(ì½ì–´ì£¼ê¸°) + ëœ» í‘œì‹œ (TTS íŒ¨ì¹˜ + ë¡œê·¸)
   ========================================================= */
function highlight(which){
  ['Base','Past','PP'].forEach(k => $('#p'+k).classList.remove('hl'));
  if(which==='base') $('#pBase').classList.add('hl');
  if(which==='past') $('#pPast').classList.add('hl');
  if(which==='pp')   $('#pPP').classList.add('hl');
}
function stopSpeak(){
  try{
    if(lastUtters.length){ lastUtters.forEach(u=>u.onend=null); lastUtters=[]; }
    if(window.speechSynthesis) speechSynthesis.cancel();
    logDiag('speechSynthesis.cancel()');
  }catch(e){ logDiag('stopSpeak error: '+e); }
}
function showStudyCard(){
  if(currentSet.length===0){ $('#bWord').textContent='(ë¹ˆ ì„¸íŠ¸)'; return; }
  const v = currentSet[ clamp(iStudy,0,currentSet.length-1) ];
  $('#bWord').textContent = v.base;
  $('#pBase').textContent = v.base;
  $('#pPast').textContent = v.past;
  $('#pPP').textContent = v.pp;
  $('#krMeaning').textContent = `ëœ»: ${v.kr||KR[v.base]||'-'}`;
  highlight('none');
  $('#promptTag').textContent = 'í•™ìŠµ ì¹´ë“œ';
}

// ëª¨ë°”ì¼ ì•ˆì •í™”ë¥¼ ìœ„í•œ async speak
async function speakTriple(v, rate=1.0, thenAuto=false){
  if(!window.speechSynthesis){ logDiag('no speechSynthesis'); return; }

  // ë³´ì´ìŠ¤ ì¤€ë¹„ + ì›œì—… (ì‚¬ìš©ì í´ë¦­ ì•ˆì—ì„œ í˜¸ì¶œë¨)
  await warmupTTS();
  await waitVoices(1200);

  // ë°œí™” ì„¤ì •
  const voice = pickEnglishVoice();
  $('#dChosen').textContent = voice ? `${voice.name} (${voice.lang})` : '-';

  // í ì´ˆê¸°í™” ë° ì•„ì£¼ ì§§ì€ ì§€ì—°
  stopSpeak();
  await sleep(60);

  const u1 = new SpeechSynthesisUtterance(v.base);
  const u2 = new SpeechSynthesisUtterance(v.past.replace('/', ' or '));
  const u3 = new SpeechSynthesisUtterance(v.pp);

  [u1,u2,u3].forEach(u=>{
    u.rate = rate; u.pitch = 1; u.lang = "en-US";
    if(voice) u.voice = voice;
    u.onstart = ()=> logDiag('onstart: '+u.text);
    u.onerror = (e)=> logDiag('onerror: '+(e?.error||'unknown'));
    u.onend = ()=> logDiag('onend: '+u.text);
  });

  u1.onstart = ()=>{ highlight('base'); logDiag('start base'); };
  u2.onstart = ()=>{ highlight('past'); logDiag('start past'); };
  u3.onstart = ()=>{ highlight('pp'); logDiag('start pp'); };
  u3.onend = async ()=>{
    highlight('none');
    if($('#autoNext').checked && thenAuto){
      iStudy++;
      if(iStudy >= currentSet.length){
        onStudyComplete();
      }else{
        showStudyCard();
        await sleep(150);
        speakTriple(currentSet[iStudy], parseFloat($('#rate').value), true);
      }
      updateStats();
    }
  };

  lastUtters=[u1,u2,u3];
  logDiag('speak: '+u1.text); speechSynthesis.speak(u1);
  await sleep(20);
  logDiag('speak: '+u2.text); speechSynthesis.speak(u2);
  await sleep(20);
  logDiag('speak: '+u3.text); speechSynthesis.speak(u3);
}

function onStudyComplete(){
  showModal("ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!","ì´ì œ í€´ì¦ˆë¥¼ í’€ì–´ë³´ì„¸ìš”. ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê°ê´€ì‹ í€´ì¦ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.","í€´ì¦ˆ ì‹œì‘",()=>{
    setMode('quiz'); startQuizFresh();
  });
}

/* =========================================================
   7) í€´ì¦ˆ â€” ê·¼ì‚¬ì˜¤ë‹µ ìƒì„±ê¸°
   ========================================================= */
const VOWELS = "aeiou";
const isVowel = ch => VOWELS.includes(ch);
function doubleLastIfCVC(base){
  const n=base.length; if(n<3) return base+"ed";
  const a=base[n-3], b=base[n-2], c=base[n-1];
  const doubleable="bdgklmnprt".includes(c);
  if(!isVowel(a) && isVowel(b) && !isVowel(c) && doubleable) return base + c + "ed";
  return base + "ed";
}
function regularize(base){
  if(base.endsWith('e')) return base+"d";
  if(base.endsWith('y') && !isVowel(base.at(-2))) return base.slice(0,-1)+"ied";
  return doubleLastIfCVC(base);
}
function smallVowelMutate(w){
  const map={a:"e", e:"a", i:"e", o:"u", u:"o"};
  for(let i=0;i<w.length;i++){
    const ch=w[i];
    if(isVowel(ch)){ return w.slice(0,i)+(map[ch]||ch)+w.slice(i+1); }
  }
  return w + w.slice(-1);
}
function nearMissAAA(base,past,pp){
  const d1 = regularize(base);
  const d2 = base + base.slice(-1) + "ed";
  const d3 = base + "ed";
  return [
    {base, past:d1, pp:d1, ok:false},
    {base, past:d2, pp:d2, ok:false},
    {base, past:base, pp:d3, ok:false}
  ];
}
function nearMissABB(base,past,pp){
  const d1 = regularize(base);
  const d2 = past + "ed";
  return [
    {base, past:d1, pp:d1, ok:false},
    {base, past:past, pp:base, ok:false},
    {base, past: d2===past? smallVowelMutate(d2):d2, pp: d2===pp? smallVowelMutate(d2):d2, ok:false}
  ];
}
function nearMissABA(base,past,pp){
  const d1 = regularize(base);
  const d2 = {past:base, pp:past};
  const d3p = smallVowelMutate(past);
  return [
    {base, past:d1, pp:d1, ok:false},
    {base, past:d2.past, pp:d2.pp, ok:false},
    {base, past:d3p, pp:base, ok:false}
  ];
}
function nearMissABC(base,past,pp){
  const d1 = {past:past, pp:past};
  const d2 = {past:pp,   pp:pp};
  const d3 = {past:regularize(base), pp:pp};
  return [
    {base, past:d1.past, pp:d1.pp, ok:false},
    {base, past:d2.past, pp:d2.pp, ok:false},
    {base, past:d3.past, pp:d3.pp, ok:false}
  ];
}
function nearMissREG(base,past,pp){
  let d1 = past.replace(/ed$/,"ked"); if(d1===past) d1 = past + past.slice(-1);
  return [
    {base, past:d1, pp:d1, ok:false},
    {base, past: base+"ed", pp: base+"t", ok:false},
    {base, past: smallVowelMutate(past), pp: smallVowelMutate(pp), ok:false}
  ];
}
function makeNearMissOptions(v){
  const correct = {base:v.base, past:v.past, pp:v.pp, ok:true};
  let candidates=[];
  if(v.pattern==="AAA") candidates = nearMissAAA(v.base,v.past,v.pp);
  else if(v.pattern==="ABB") candidates = nearMissABB(v.base,v.past,v.pp);
  else if(v.pattern==="ABA") candidates = nearMissABA(v.base,v.past,v.pp);
  else if(v.pattern==="ABC") candidates = nearMissABC(v.base,v.past,v.pp);
  else candidates = nearMissREG(v.base,v.past,v.pp);

  const seen=new Set([`${correct.base}|${correct.past}|${correct.pp}`]);
  const outs=[correct];
  for(const c of candidates){
    const key = `${c.base}|${c.past}|${c.pp}`;
    if(!seen.has(key) && c.past && c.pp){ seen.add(key); outs.push(c); }
    if(outs.length>=4) break;
  }
  while(outs.length<4){
    const p2 = smallVowelMutate(v.past);
    const pp2 = smallVowelMutate(v.pp);
    const c = {base:v.base, past:p2, pp:pp2, ok:false};
    const key = `${c.base}|${c.past}|${c.pp}`;
    if(!seen.has(key)){ seen.add(key); outs.push(c); }
  }
  return shuffle(outs);
}

/* =========================================================
   8) í€´ì¦ˆ ì¹´ë“œ
   ========================================================= */
function showQuizCard(){
  $('#promptTag').textContent = 'í€´ì¦ˆ';
  const box = $('#opts'); box.innerHTML = '';
  if(currentSet.length===0){ $('#qBase').textContent='(ë¹ˆ ì„¸íŠ¸)'; return; }
  if(qi >= qOrder.length){
    const total = currentSet.length; const acc = total? Math.round(ok/total*100) : 0;
    const body = `
      <div class="grid-2">
        <div><b>ì´ ë¬¸í•­</b><br>${total}</div>
        <div><b>ì •ë‹µ/ì˜¤ë‹µ</b><br>${ok} / ${no}</div>
      </div>
      <div style="margin-top:10px"><b>ì •í™•ë„</b> â€” ${acc}%</div>
      <div style="margin-top:10px"><b>íŒ¨í„´ë³„ ì •ë‹µ</b></div>
      <div class="grid-2" style="margin-top:6px">
        <div>AAA: ${patternCorrect.AAA}/${patternTotals.AAA}</div>
        <div>ABB: ${patternCorrect.ABB}/${patternTotals.ABB}</div>
        <div>ABA: ${patternCorrect.ABA}/${patternTotals.ABA}</div>
        <div>ABC: ${patternCorrect.ABC}/${patternTotals.ABC}</div>
        <div>REG: ${patternCorrect.REG}/${patternTotals.REG}</div>
      </div>
      <div class="small" style="margin-top:10px; opacity:.9">ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì˜¤ë‹µë§Œ ë‹¤ì‹œ í’€ ìˆ˜ ìˆì–´ìš”.</div>
    `;
    showModal("ì„¸íŠ¸ ì™„ë£Œ!", body, "ë‹¤ìŒ ì„¸íŠ¸ë¡œ", ()=>{
      if($('#onlyWrong').checked && wrongList.length>0){
        currentSet = shuffle(wrongList.slice());
        setIndex = 0; ok=0; no=0; qi=0; history=[]; wrongList=[];
        patternTotals = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
        patternCorrect = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
        currentSet.forEach(v => patternTotals[v.pattern]++);
        qOrder = shuffle([...currentSet.keys()]);
        showQuizCard(); updateStats(); hideModal();
      }else{
        setIndex++; buildSets(); setMode('quiz'); hideModal();
      }
    });
    return;
  }

  const idxSet = qOrder[qi];
  const v = currentSet[idxSet];
  $('#qBase').textContent = v.base;

  const opts = makeNearMissOptions(v);
  qLocked = false;

  opts.forEach((o)=>{
    const div = document.createElement('div');
    div.className = 'opt';
    div.innerHTML = `<div class="t">${o.base} â€“ ${o.past} â€“ ${o.pp}</div>`;
    div.addEventListener('click', ()=>{
      if(qLocked) return;
      qLocked = true;

      const wasCorrect = o.ok===true;
      if(wasCorrect){
        ok++; history.unshift({base:v.base, past:v.past, pp:v.pp});
        patternCorrect[v.pattern] = (patternCorrect[v.pattern]||0)+1;
      }else{
        no++;
        if(!wrongList.some(w=>w.base===v.base && w.past===v.past && w.pp===v.pp)) wrongList.push(v);
      }
      updateStats();
      playSnd(wasCorrect);

      qi++;
      showQuizCard();
    });
    box.appendChild(div);
  });

  updateStats();
}

/* =========================================================
   9) ë Œë”ë§ ë³´ì¡°
   ========================================================= */
function renderHistory(){
  const box = $('#history'); box.innerHTML='';
  history.slice(0,10).forEach(h=>{
    const s = document.createElement('span');
    s.className='chip'; s.textContent = `${h.base} â†’ ${h.past} â†’ ${h.pp}`;
    box.appendChild(s);
  });
}
function renderWrongs(){
  const box = $('#wrongs'); box.innerHTML='';
  wrongList.forEach(w=>{
    const s = document.createElement('span');
    s.className='chip'; s.textContent = `${w.base}/${w.past}/${w.pp}`;
    box.appendChild(s);
  });
}

/* =========================================================
   10) í™”ë©´ ì „í™˜ / ì´ë²¤íŠ¸
   ========================================================= */
function setMode(m){
  mode = m;
  if(mode==='study'){
    $('#screenStudy').classList.remove('hidden');
    $('#screenQuiz').classList.add('hidden');
    $('#promptTag').textContent = 'í•™ìŠµ ì¹´ë“œ';
  }else{
    $('#screenQuiz').classList.remove('hidden');
    $('#screenStudy').classList.add('hidden');
    $('#promptTag').textContent = 'í€´ì¦ˆ';
  }
  updateStats();
}
function startQuizFresh(){
  qi=0; ok=0; no=0; wrongList=[]; history=[];
  patternCorrect = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
  qOrder = shuffle([...currentSet.keys()]);
  setMode('quiz'); showQuizCard(); updateStats();
}

// ì˜µì…˜
$('#mode').addEventListener('change', e=> setMode(e.target.value));
$('#setSize').addEventListener('change', ()=>{ setIndex=0; buildSets(); });
$('#patternFilter').addEventListener('change', ()=>{ setIndex=0; buildSets(); });
$('#rate').addEventListener('input', e=> $('#spdTxt').textContent = e.target.value);

// í•™ìŠµ ë²„íŠ¼ (í´ë¦­ ì œìŠ¤ì²˜ ì•ˆì—ì„œ speakTriple í˜¸ì¶œ)
$('#btnPlay').addEventListener('click', async ()=>{
  if(currentSet.length===0) return;
  const v = currentSet[iStudy];
  await speakTriple(v, parseFloat($('#rate').value), false);
});
$('#btnRepeat').addEventListener('click', async ()=>{
  if(currentSet.length===0) return;
  const v = currentSet[iStudy];
  await speakTriple(v, parseFloat($('#rate').value), true);
});
$('#btnStop').addEventListener('click', stopSpeak);
$('#btnNext').addEventListener('click', ()=>{
  stopSpeak();
  iStudy++;
  if(iStudy>=currentSet.length){ onStudyComplete(); iStudy=currentSet.length; }
  else{ showStudyCard(); }
  updateStats();
});
$('#btnPrev').addEventListener('click', ()=>{
  stopSpeak();
  iStudy = Math.max(iStudy-1, 0);
  showStudyCard(); updateStats();
});

// ìš°ì¸¡ íŒ¨ë„
$('#btnStartStudy').addEventListener('click', ()=>{ setMode('study'); iStudy=0; showStudyCard(); updateStats(); });
$('#btnStartQuiz').addEventListener('click', ()=> startQuizFresh());
$('#btnNextSet').addEventListener('click', ()=>{ setIndex++; buildSets(); setMode($('#mode').value); });

// í•˜ë‹¨
$('#btnReset').addEventListener('click', ()=>{ setIndex=0; buildSets(); setMode('study'); });
$('#btnWrongOnly').addEventListener('click', ()=>{
  if(wrongList.length===0){ alert('ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  currentSet = shuffle(wrongList.slice());
  patternTotals = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
  patternCorrect = {AAA:0, ABB:0, ABA:0, ABC:0, REG:0};
  currentSet.forEach(v => patternTotals[v.pattern]++);
  setIndex = 0; ok=0; no=0; qi=0; history=[];
  wrongList=[];
  qOrder = shuffle([...currentSet.keys()]);
  setMode('quiz'); showQuizCard(); updateStats();
});

/* =========================================================
   11) ëª¨ë‹¬
   ========================================================= */
function showModal(title, bodyHTML, actionText, actionFn){
  $('#modalTitle').textContent = title;
  $('#modalBody').innerHTML = bodyHTML;
  $('#btnModalAction').textContent = actionText || 'í™•ì¸';
  $('#btnModalAction').onclick = actionFn || hideModal;
  $('#btnModalClose').onclick = hideModal;
  $('#modal').classList.add('show');
}
function hideModal(){ $('#modal').classList.remove('show'); }

/* =========================================================
   12) ì§„ë‹¨ íŒ¨ë„ ë¡œì§
   ========================================================= */
function formatVoices(){
  const vs = (speechSynthesis && speechSynthesis.getVoices) ? speechSynthesis.getVoices() : [];
  const lines = vs.map((v,i)=> `${i}. ${v.name}  [${v.lang}]  ${v.default ? '(default)' : ''}`).join('\n');
  $('#dVoices').textContent = lines || '(ë³´ì´ìŠ¤ ì—†ìŒ)';
  $('#dCount').textContent = String(vs.length);
  const sel = $('#dVoice'); if(!sel) return;
  sel.innerHTML = vs.map((v,i)=> `<option value="${i}">${i}. ${v.name} [${v.lang}] ${v.default?'(default)':''}</option>`).join('');
}
function updateDiag(){
  $('#dReady').textContent = String(voicesReady);
  $('#dWarmed').textContent = String(ttsWarmed);
  formatVoices();
}
function openDiag(){ $('#diag').classList.add('show'); updateDiag(); }
function closeDiag(){ $('#diag').classList.remove('show'); }

$('#btnDiag').addEventListener('click', openDiag);
$('#btnDiagClose').addEventListener('click', closeDiag);
$('#dRefresh').addEventListener('click', async ()=>{ 
  logDiag('manual refresh voices'); 
  await waitVoices(1000); 
  updateDiag(); 
});
$('#dWarm').addEventListener('click', async ()=>{ 
  logDiag('manual warmup'); 
  await warmupTTS(); 
  updateDiag(); 
});
$('#dStop').addEventListener('click', stopSpeak);
$('#dSayHello').addEventListener('click', async ()=>{
  await warmupTTS(); await waitVoices(1000);
  const v = pickEnglishVoice();
  const u = new SpeechSynthesisUtterance('hello');
  u.lang = 'en-US'; u.pitch = 1; u.rate = 1;
  if(v) u.voice = v;
  u.onstart = ()=>logDiag('hello onstart');
  u.onend = ()=>logDiag('hello onend');
  u.onerror = (e)=>logDiag('hello onerror: ' + (e?.error||'unknown'));
  speechSynthesis.speak(u);
});
$('#dSayTriple').addEventListener('click', async ()=>{
  if(!currentSet.length){ logDiag('no currentSet'); return; }
  const v = currentSet[iStudy];
  await speakTriple(v, parseFloat($('#rate').value)||1.0, false);
});
$('#dPlayCorrect').addEventListener('click', ()=>{ try{$('#sndCorrect').currentTime=0; $('#sndCorrect').play();}catch(_){} });
$('#dPlayWrong').addEventListener('click', ()=>{ try{$('#sndWrong').currentTime=0; $('#sndWrong').play();}catch(_){} });
$('#dCopy').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText($('#dLog').textContent || '');
    alert('ë³µì‚¬ëìŠµë‹ˆë‹¤.');
  }catch(e){ alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ ì‹¤íŒ¨'); }
});
$('#dClear').addEventListener('click', ()=> $('#dLog').textContent='');

/* voiceschanged ì´ë²¤íŠ¸: ì§„ë‹¨ í‘œì‹œ ì—…ë°ì´íŠ¸ */
if(window.speechSynthesis){
  speechSynthesis.addEventListener('voiceschanged', ()=>{
    voicesChangedCount++;
    logDiag('voiceschanged (global); count=' + speechSynthesis.getVoices().length);
    updateDiag();
  });
}

/* =========================================================
   13) ì‹œì‘ + SW ë“±ë¡
   ========================================================= */
window.addEventListener('DOMContentLoaded', ()=>{
  $('#spdTxt').textContent = $('#rate').value;
  buildSets();
  setMode('study');
  showStudyCard();
  updateStats();
  updateDiag();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
});
</script>
</body>
</html>


